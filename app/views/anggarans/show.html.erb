<nav aria-label="breadcrumb" class="d-none d-md-inline-block mb-3">
  <ol class="breadcrumb breadcrumb-dark breadcrumb-transparent mb-0">
    <li class="breadcrumb-item">
      <%= link_to root_path do %>
        <i class="fas fa-home"></i>
      <% end %>
    </li>
    <li class="breadcrumb-item" aria-current="page"><%= link_to 'Sasaran Kinerja', user_sasarans_path(current_user.id) %></li>
    <li class="breadcrumb-item" aria-current="page"><%= link_to @sasaran.sasaran_kinerja, sasaran_path(@tahapan.sasaran) %></li>
    <li class="breadcrumb-item active" aria-current="page">Anggaran</li>
  </ol>
</nav>
<div class="card border-2 shadow mb-3">
  <div class="card-header">
    <div class="row align-items-center">
      <p><%= link_to sasaran_path(@tahapan.sasaran) do %>
        <span class="fas fa-arrow-left"></span>
        <span>Kembali</span>
      <% end %>
      </p>
      <h5>Sasaran : <%= @sasaran.sasaran_kinerja %></h5>
      <h5>Tahapan : <%= @tahapan.tahapan_kerja %></h5>
    </div>
  </div>
  <div class="card-body">
    <h5>Rincian Anggaran</h5>
    <div class="anggaran">
    <table id="detail-anggaran">
      <thead>
        <tr>
          <th rowspan="2">Kode Rekening</th>
          <th rowspan="2">Uraian</th>
          <th colspan="3">Rincian Perhitungan</th>
          <th rowspan="2">PPN (10%)</th>
          <th rowspan="2">Jumlah</th>
        </tr>
        <tr>
          <th>Koefisien</th>
          <th>Satuan</th>
          <th>Harga</th>
        </tr>
      </thead>
      <tbody>
        <tr class="level-0">
          <td><%= rekening_anggaran @anggaran.kode_rek %></td>
          <td colspan="5"><%= @anggaran.uraian %>
          <% if @anggaran.level == 4 %>
            <%= render :partial => 'modal_perhitungans', :locals => { :anggaran => @anggaran } %>
            <%= link_to '[ + ]', '#',remote: true, data: { 'bs-toggle': 'modal', 'bs-target': "#form-perhitungan-#{@anggaran.id}"}, class: "btn btn-sm btn-info text-secondary animate-up-2"   %>
            <%= link_to "Edit Anggaran", edit_sasaran_tahapan_anggaran_path(@sasaran, @tahapan, @anggaran)  %>
          <% else %>
            <%= link_to '[ + ] 1', '#', remote: true, data: { 'bs-toggle': 'modal', 'bs-target': '#form-anggaran', 'level': 1, 'parent': @anggaran.id } %>
          <% end %>
          </td>
          <td class="uang"><%= number_with_delimiter(@anggaran.jumlah, :delimiter => '.') %></td>
        </tr>
        <% if @anggaran.perhitungans.any? %>
            <% @anggaran.perhitungans.order(:id).each do |hitung| %>
              <% pajak = hitung.total * @anggaran.pajak.potongan %>
              <tr class="rincian-anggaran">
                <td><%= link_to "Hapus Anggaran", anggaran_perhitungan_path(@anggaran, hitung), method: :delete, data: { confirm_swal: "Hapus Anggaran #{hitung.deskripsi} ?" }, class: "btn btn-danger" %></td>
                <td><%= link_to hitung.deskripsi, edit_anggaran_perhitungan_path(@anggaran, hitung) %></td>
                <td><% hitung.koefisiens.each do |koef|%>
                  |  <%= koef.volume %> <%= koef.satuan_volume %>  |
                  <% end %>
                </td>
                <td><%= hitung.satuan %></td>
                <td><%= number_with_delimiter(hitung.harga, :delimiter => '.') %></td>
                <td><%= (@anggaran.pajak.potongan * 100).to_i %> %</td>
                <td class="uang"><%= number_with_delimiter((hitung.total).to_i, :delimiter => '.') %></td>
              </tr>
            <% end %>
        <% end %>
        <% @anggaran.childs.order(:id).each do |child| %>
          <tr class="level-1">
            <td><%= @anggaran.kode_rek + child.kode_rek %></td>
            <td colspan="5"><%= link_to  child.uraian, edit_rincian_tahapan_anggaran_path(@rincian, @tahapan, child) %>
            <%= link_to '[ + ] 2', '#', remote: true, data: { 'bs-toggle': 'modal', 'bs-target': '#form-anggaran', 'level': child.level + 1, 'parent': child.id } %>
            </td>
            <td class="uang"><%= number_with_delimiter(child.jumlah, :delimiter => '.') %></td>
          </tr>
          <% child.childs.order(:id).each do |child2| %>
          <tr>
            <td><%= @anggaran.kode_rek + child.kode_rek + child2.kode_rek %></td>
            <td colspan="5"><%= link_to child2.uraian, edit_rincian_tahapan_anggaran_path(@rincian, @tahapan, child2) %>
            <%= link_to '[ + ] 3', '#', remote: true, data: { 'bs-toggle': 'modal', 'bs-target': '#form-anggaran', 'level': child2.level + 1, 'parent': child2.id } %>
            </td>
            <td class="uang"><%= number_with_delimiter(child2.jumlah, :delimiter => '.') %></td>
          </tr>
          <% child2.childs.order(:id).each do |child3| %>
          <tr>
            <td><%= @anggaran.kode_rek + child.kode_rek + child2.kode_rek + child3.kode_rek %></td>
            <td colspan="5"><%= link_to child3.uraian, edit_rincian_tahapan_anggaran_path(@rincian, @tahapan, child3) %>
            <%= link_to '[ + ] 4', '#', remote: true, data: { 'bs-toggle': 'modal', 'bs-target': '#form-anggaran', 'level': child3.level + 1 , 'parent': child3.id} %>
            </td>
            <td class="uang"><%= number_with_delimiter(child3.jumlah, :delimiter => '.') %></td>
          </tr>
          <% child3.childs.order(:id).each do |child4| %>
          <tr>
            <td><%= @anggaran.kode_rek + child.kode_rek + child2.kode_rek + child3.kode_rek + child4.kode_rek %>
            level : <%= child4.level  %></td>
            <td colspan="5"><%= link_to child4.uraian, edit_rincian_tahapan_anggaran_path(@rincian, @tahapan, child4) %>
            <%= link_to '[ + ] 5', '#', remote: true, data: { 'bs-toggle': 'modal', 'bs-target': '#form-anggaran', 'level': child4.level + 1 , 'parent': child4.id}  %>
            </td>
            <td class="uang"><%= number_with_delimiter(child4.jumlah, :delimiter => '.') %></td>
          </tr>
          <tr class="kres-tahapan">
            <td></td>
            <td colspan="6">#<%= @tahapan.tahapan_kerja %></td>
          </tr>
          <% child4.childs.order(:id).each do |child5| %>
          <%= render :partial => 'modal_perhitungans', :locals => { :anggaran => child5 } %>
          <tr>
            <td><%= child5.kode_rek %></td>
            <td colspan="6">[ - ]
            <%= link_to child5.uraian, edit_rincian_tahapan_anggaran_path(@rincian, @tahapan, child5) %>
            <%= link_to '[ + ]', '#',remote: true, data: { 'bs-toggle': 'modal', 'bs-target': "#form-perhitungan-#{child5.id}"}   %>
            </td>
          </tr>
          <% if child5.perhitungans.any? %>
            <% child5.perhitungans.order(:id).each do |hitung| %>
              <% pajak = hitung.total * child5.pajak.potongan %>
              <tr class="rincian-anggaran">
                <td>hapus_anggaran</td>
                <td><%= link_to hitung.deskripsi, edit_anggaran_perhitungan_path(child5, hitung) %></td>
                <td><% hitung.koefisiens.each do |koef|%>
                  |  <%= koef.volume %> <%= koef.satuan_volume %>  |
                  <% end %>
                </td>
                <td><%= hitung.satuan %></td>
                <td><%= number_with_delimiter(hitung.harga, :delimiter => '.') %></td>
                <td><%= (child5.pajak.potongan * 100).to_i %> %</td>
                <td class="uang"><%= number_with_delimiter((hitung.total).to_i, :delimiter => '.') %></td>
              </tr>
            <% end %>
          <% end %>
          <% end %>
          <% end %>
          <% end %>
          <% end %>
        <% end %>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="6" style="text-align:right">Jumlah Anggaran Sub Kegiatan :</td>
          <td><%= number_with_delimiter((@anggaran.jumlah).to_i, :delimiter => '.') %></td>
        </tr>
      </tfoot>
    </table>
  </div>
  </div>
</div>
<!-- SECTION - Table Anggaran -->
<!-- !SECTION - End Table Anggaran -->
<%= render 'modal' %>
