<p id="notice"><%= notice %></p>
<h2>User : <%= @sasaran.user.nama %></h2>
<h2>NIK : <%= link_to @sasaran.user.nik, user_path(@sasaran.user) %></h2>
<hr>
<% unless @sasaran.program_kegiatan %>
<h3>Tambah Sub Kegiatan</h3>
<% program = ProgramKegiatan.all %>
<%= form_with(model: @sasaran, local: true) do |form| %>
  <div class="field">
    <% options = options_from_collection_for_select(program, 'id', 'nama_subkegiatan') %>
    <%= form.label :program_kegiatan_id, 'Sub Kegiatan : ' %>
    <%= form.select :program_kegiatan_id, options %>
  </div>
   <div class="actions">
    <%= form.submit %>
  </div>
  <% end %>
<% else %>
<p>
  <strong>Sub Kegiatan :</strong>
  <%= link_to @sasaran.program_kegiatan.nama_subkegiatan, program_kegiatan_path(@sasaran.program_kegiatan) %>
</p>
<% end %>
<hr>
<p>
  <strong>Sasaran kinerja:</strong>
  <%= @sasaran.sasaran_kinerja %>
</p>

<p>
  <strong>Indikator kinerja:</strong>
  <%= @sasaran.indikator_kinerja %>
</p>

<p>
  <strong>Target:</strong>
  <%= @sasaran.target %>
</p>

<p>
  <strong>Satuan:</strong>
  <%= @sasaran.satuan %>
</p>

<p>
  <strong>Penerima manfaat:</strong>
  <%= @sasaran.penerima_manfaat %>
</p>

<% unless @sasaran.rincian %>
<p>
  <strong>Harap isi Rincian Sasaran</strong>
  <hr>
  <%= render 'rincians/form', rincian: @sasaran.build_rincian %>
</p>
<% else %>
  <p>
    <strong>Data Terpilah :</strong>
    <%= @sasaran.rincian.data_terpilah %>
  </p>
<!-- NOTE : Refactor -->
  <p>
    <strong>Penyebab Internal :</strong>
    <%= @sasaran.rincian.penyebab_internal %>
  </p>
  <p>
    <strong>Penyebab External :</strong>
    <%= @sasaran.rincian.penyebab_external %>
  </p>
  
  <p>
    <strong>Permasalahan Umum :</strong>
    <%= @sasaran.rincian.permasalahan_umum %>
  </p>
  <p>
    <strong>Permasalahan Gender :</strong>
    <%= @sasaran.rincian.permasalahan_gender %>
  </p>

  <p>
    <strong>Resiko</strong>
    <%= @sasaran.rincian.resiko  %>
  </p>

  <p>
    <strong>Lokasi Pelaksanaan</strong>
    <%= @sasaran.rincian.lokasi_pelaksanaan  %>
  </p>

  <% unless @sasaran.rincian.tahapans.any? %>
    <%= link_to 'Tambah Renaksi', new_rincian_tahapan_path(@sasaran.rincian) %>
  <% else %>
  <hr>
    <h3>Rencana Aksi ( Tahapan pelaksaanaan ) </h3>
    <%= link_to 'Tambah Renaksi', new_rincian_tahapan_path(@sasaran.rincian) %>
      <hr>
      <!-- TODO - Refactor and Add AJAX -->
      <table class="renaksi">
      <thead>
      <tr>
        <th rowspan="2">No</th>
        <th rowspan="2">Tahapan Kerja</th>
        <% (1..12).each do |i| %>
        <th colspan="2"><%= i %></th>
        <% end %>
        <th colspan="2">Jumlah</th>
        <th rowspan="2">Keterangan</th>
        <th rowspan="2">Action</th>
      </tr>
      <tr>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
        <td>T</td>
        <td>R</td>
      </tr>
      </thead>
      <tbody>
    <% @sasaran.rincian.tahapans.each.with_index(1) do |tahapan, index| %>
      <% aksi = tahapan.aksis %>
        <tr>
          <td><%= index %></td>
          <td><%= tahapan.tahapan_kerja %></td>
          <!-- 1-->
          <td><%= aksi.find_by(bulan: 1) ? aksi.find_by(bulan: 1).target : ''   %> </td>
          <td><%=  aksi.find_by(bulan: 1) ? aksi.find_by(bulan: 1).realisasi : ''  %></td>
          <!-- 1-->
          <td><%= aksi.find_by(bulan: 2) ? aksi.find_by(bulan: 2).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 2) ? aksi.find_by(bulan: 2).realisasi : ''  %></td>
          <!-- 1-->
          <td><%= aksi.find_by(bulan: 3) ? aksi.find_by(bulan: 3).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 3) ? aksi.find_by(bulan: 3).realisasi : ''  %></td>
          <!-- 1-->
          <td><%= aksi.find_by(bulan: 4) ? aksi.find_by(bulan: 4).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 4) ? aksi.find_by(bulan: 4).realisasi : ''  %></td>
          <!-- 1-->
          <td><%= aksi.find_by(bulan: 5) ? aksi.find_by(bulan: 5).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 5) ? aksi.find_by(bulan: 5).realisasi : ''  %></td>
          <!-- 1-->
         <td><%= aksi.find_by(bulan: 6) ? aksi.find_by(bulan: 6).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 6) ? aksi.find_by(bulan: 6).realisasi : ''  %></td>
          <!-- 1-->
         <td><%= aksi.find_by(bulan: 7) ? aksi.find_by(bulan: 7).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 7) ? aksi.find_by(bulan: 7).realisasi : ''  %></td>
          <!-- 1-->
          <td><%= aksi.find_by(bulan: 8) ? aksi.find_by(bulan: 8).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 8) ? aksi.find_by(bulan: 8).realisasi : ''  %></td>
          <!-- 9 -->
         <td><%= aksi.find_by(bulan: 9) ? aksi.find_by(bulan: 9).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 9) ? aksi.find_by(bulan: 9).realisasi : ''  %></td>
          <!--10 -->
          <td><%= aksi.find_by(bulan: 10) ? aksi.find_by(bulan: 10).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 10) ? aksi.find_by(bulan: 10).realisasi : ''  %></td>
          <!-- 11 -->
          <td><%= aksi.find_by(bulan: 11) ? aksi.find_by(bulan: 11).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 11) ? aksi.find_by(bulan: 11).realisasi : ''  %></td>
          <!-- 12-->
         <td><%= aksi.find_by(bulan: 12) ? aksi.find_by(bulan: 12).target : ''   %></td>
          <td><%=  aksi.find_by(bulan: 12) ? aksi.find_by(bulan: 12).realisasi : ''  %></td>
          <!-- Sum -->
          <td><%= tahapan.jumlah_target  %></td>
          <td><%= tahapan.jumlah_realisasi %></td>
          <td><%= tahapan.keterangan  %></td>
          <td><%= link_to 'Add', new_rincian_tahapan_aksi_path(@sasaran.rincian, tahapan) %></td>
        </tr>
    <% end %>
      </tbody>
      <tfoot>
      <% total_target_aksi_bulan = Aksi.all.group(:bulan).sum(:target) %>
      <% total_realisasi_aksi_bulan = Aksi.all.group(:bulan).sum(:realisasi) %>
        <tr>
          <td colspan="2">Total</td>
          <% (1..12).each do |i| %>
          <td><%= total_target_aksi_bulan[i] %></td>
          <td><%= total_realisasi_aksi_bulan[i] %></td>
          <% end %>
          <td><%= @sasaran.rincian.tahapans.sum :jumlah_target %></td>
          <td><%= @sasaran.rincian.tahapans.sum :jumlah_realisasi %></td>
          <td colspan="2"></td>
        </tr>
      </tfoot>
      </table>
    
      <hr>

  <% end %>
  <!-- TODO: Add ajax to inline form -->
  <% unless @sasaran.pagus.any? %>
    <%= link_to 'Tambah Pagu', new_sasaran_pagu_path(@sasaran) %>

  <% else %>
    <hr>
    <h3>Pagu  <span>
    <h3>Pagu Total : <%= number_with_delimiter(@sasaran.pagus.sum(:total) , :delimiter => ',') %></h3>
    <%= link_to 'Tambah Pagu', new_sasaran_pagu_path(@sasaran) %>
    </span></h3>
   
    <% @sasaran.pagus.each do |pagu| %>
    <hr>
      <p>
        <strong>Item: </strong>
        <%= pagu.item %>
      </p>
      <p>
        <strong>Uang: </strong>
        <%= number_with_delimiter pagu.uang, :delimiter => ',' %>
      </p>
       <p>
        <strong>Satuan: </strong>
        <%= pagu.satuan %>
      </p>
       <p>
        <strong>Volume: </strong>
        <%= pagu.volume %>
      </p>
      <p>
        <strong>Total :</strong>
        <%= pagu.total %>
      </p>
      <p>
        <%= link_to 'Edit', edit_sasaran_pagu_path(@sasaran, pagu) %>
        <%= link_to 'Delete', sasaran_pagu_path(@sasaran, pagu), method: :delete, data: { confirm: "Hapus Pagu #{pagu.item} ?" } %>
      </p>
      <hr>
    <% end %>
  <% end %>
  

<% end %>


